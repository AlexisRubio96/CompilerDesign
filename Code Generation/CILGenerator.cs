/*
 * A01373670 - Rodrigo Garcia Lopez
 * A01372074 - Jorge Alexis Rubio Sumano
 * A01371084 - Valentin Ochoa Lopez
*/

using System;
using System.Text;
using System.Collections.Generic;

namespace Chimera {

    class CILGenerator {

        //-----------------------------------------------------------
        static readonly IDictionary<Type, string> CILTypes =
            new Dictionary<Type, string>() {
                { Type.VOID, "void" },
                { Type.INTEGER, "int32"},
                { Type.STRING, "not implemented"},
            };

        //-----------------------------------------------------------
        public GlobalSymbolTable GSTable
        {
            get;
            private set;
        }

        //-----------------------------------------------------------
        public GlobalProcedureTable GPTable
        {
            get;
            private set;
        }

        //-----------------------------------------------------------
        public CILGenerator(GlobalSymbolTable gsTable, GlobalProcedureTable gpTable)
        {
            GSTable = gsTable;
            GPTable = gpTable;
        }

        //-----------------------------------------------------------
        public string Visit(Program node)
        {
            return "// Code generated by the chimera compiler.\n\n"
                + ".assembly 'chimera' {}\n\n"
                + ".assembly extern 'chimeralib' {}\n\n"
                + ".class public 'ChimeraProgram' extends "
                + "['mscorlib']'System'.'Object' {\n"
                + "\t.method public static void 'main'() {\n"
                + "\t\t.entrypoint\n"
                + VisitChildren((dynamic)node, GSTable)
                +"\t\tret\n"
                + "\t}\n"
                + "}\n";
        }

        //-----------------------------------------------------------
        private string Visit(Node node, Table table)
        {
            Console.WriteLine(node + " visit not implemented yet");
            return "";
        }

        //-----------------------------------------------------------
        private string Visit(StatementList node, Table table)
        {
            return VisitChildren(node, table);
        }

        //-----------------------------------------------------------
        private string Visit(CallStatement node, Table table)
        {
            var retString = VisitChildren(node, table);

            var procName = node.AnchorToken.Lexeme;
            var proc = GPTable[procName];
            var procParamsTypes = "";
            var procParams = proc.getParameters();

            if (procParams.Length > 0) {
                procParamsTypes = CILTypes[procParams[0].LocalType];
                for (var i = 1; i < procParams.Length; i++)
                {
                    procParamsTypes += "," + CILTypes[procParams[i].LocalType];
                }
            }

            if (proc.IsPredefined)
            {
                retString += "\t\tcall " + CILTypes[proc.ReturnType] + " class ['chimeralib']'Chimera'.'Utils'::'" + procName + "'(" + procParamsTypes + ")\n";
            }
            else
            {
                Console.WriteLine("Not implemented yet");
            }

            return retString;
        }

        //-----------------------------------------------------------
        public string Visit(IntegerLiteral node, Table table)
        { 
            var intValue = Convert.ToInt32(node.AnchorToken.Lexeme);
            return "\t\tldc.i4 " + intValue  + "\n";
        }

        //-----------------------------------------------------------
        private string VisitChildren(Node node, Table table)
        {
            var sb = new StringBuilder();
            foreach (var n in node)
            {
                sb.Append(Visit((dynamic)n, table));
            }
            return sb.ToString();
        }
    }
}
